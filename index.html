<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>家庭螢幕時間管理</title>
  <style>
    /* （保留你的 CSS 不變，省略這裡） */
  </style>
</head>
<body>

<h1>家庭螢幕時間管理</h1>
<div id="family-select" class="family-select"></div>
<div id="children"></div>
<div style="margin-top:30px;"><button onclick="resetFamilyChoice()">重新選擇家庭</button></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbw29KdvF1gSJnTjcDn0LZCvJ06JLdK4YLE5L7V3Zy0ai6qHOONYmeV-AsMLA97N9mC-lA/exec";
let family = localStorage.getItem('family') || '';
let kids = {};

function chooseFamily() {
  document.getElementById('family-select').innerHTML = `
    <button onclick="selectFamily('ev-family')">Emmett & Miles</button>
    <button onclick="selectFamily('ap-family')">Archer & Tessa</button>
  `;
}

function selectFamily(fam) {
  family = fam;
  localStorage.setItem('family', family);
  loadData();
}

function resetFamilyChoice() {
  localStorage.removeItem('family');
  family = '';
  document.getElementById('children').innerHTML = '';
  chooseFamily();
}

function loadData() {
  if (!family) {
    chooseFamily();
    return;
  }
  const oldScript = document.getElementById('jsonp-script');
  if (oldScript) {
    oldScript.remove();
  }
  const script = document.createElement('script');
  script.id = 'jsonp-script';
  script.src = `${API_URL}?family=${family}&callback=handleData`;
  document.body.appendChild(script);
}

function handleData(data) {
  kids = data;
  render();
}

function render() {
  const container = document.getElementById('children');
  container.innerHTML = '';
  Object.keys(kids).forEach(name => {
    const kid = kids[name];
    const maxMinutes = 90;
    const percentage = Math.min(100, (kid.minutes / maxMinutes) * 100);
    const barColor = kid.minutes <= 10 ? 'linear-gradient(90deg, #ff4d4d, #ff0000)' : 'linear-gradient(90deg, #00d4ff, #005eff)';

    const card = document.createElement('div');
    card.className = 'child-card';
    card.innerHTML = `
      <div id="updated-${name}" class="updated-message">✅ 已更新</div>
      <h2>${name}</h2>
      <div class="points-box">${kid.points} 點</div>
      <div class="progress-bar-container">
        <div class="progress-bar-fill" style="width:${percentage}%; background:${barColor};"></div>
        <div class="progress-bar-text">${kid.minutes}分</div>
      </div>
      <div class="controls">
        <input id="points-${name}" type="number" placeholder="+/-點數">
        <input id="reason-${name}" type="text" placeholder="原因">
        <button onclick="changePoints('${name}')">送出加減點</button><br>
        <input id="decrease-${name}" type="number" placeholder="扣螢幕分鐘">
        <button onclick="decreaseScreen('${name}')">扣除螢幕時間</button><br>
        <input id="reset-${name}" type="number" placeholder="今日螢幕設定">
        <button onclick="resetScreen('${name}')">設定今日時間</button><br>
        <button onclick="convertMinutes('${name}')">轉換剩餘時間為點數</button>
      </div>
      <div class="last-modified" id="last-modified-${name}">${kid.lastModified ? `最後更新：${kid.lastModified}` : ''}</div>
    `;
    container.appendChild(card);
  });
}

function showUpdatedMessage(name) {
  const msg = document.getElementById(`updated-${name}`);
  if (msg) {
    msg.style.opacity = 1;
    setTimeout(() => {
      msg.style.opacity = 0;
    }, 1500);
  }
}

function changePoints(name) {
  const points = parseInt(document.getElementById(`points-${name}`).value);
  const reason = document.getElementById(`reason-${name}`).value || '調整點數';
  if (isNaN(points)) return;
  submitChange(name, points, 0, reason);
}

function decreaseScreen(name) {
  const minutes = parseInt(document.getElementById(`decrease-${name}`).value);
  if (isNaN(minutes) || minutes <= 0) return;
  submitChange(name, 0, -minutes, '扣除螢幕時間');
}

function resetScreen(name) {
  const minutes = parseInt(document.getElementById(`reset-${name}`).value);
  if (isNaN(minutes) || minutes < 0) return;
  submitChange(name, 0, minutes - (kids[name]?.minutes || 0), '設定今日螢幕時間');
}

function convertMinutes(name) {
  const availableMinutes = kids[name]?.minutes || 0;
  const pointsToAdd = Math.floor(availableMinutes / 2);
  if (pointsToAdd <= 0) return;
  if (confirm(`將剩餘 ${availableMinutes} 分鐘轉換成 ${pointsToAdd} 點嗎？`)) {
    submitChange(name, pointsToAdd, -availableMinutes, '轉換螢幕時間為點數');
  }
}

function submitChange(name, pointsChange, minutesChange, reason) {
  fetch(`${API_URL}?family=${family}`, {
    method: 'POST',
    body: JSON.stringify({
      Name: name,
      PointsChange: pointsChange,
      ScreenMinutesChange: minutesChange,
      Reason: reason
    }),
    headers: { 'Content-Type': 'application/json' }
  }).then(() => {
    showUpdatedMessage(name);
    setTimeout(loadData, 500);
  });
}

loadData();
</script>
<div style="margin-top: 60px; font-size: 0.9em; color: #aaa; text-align: center;">
    Made by Evelyn YT ｜© 2025 | 2025/4/28 10:05
</body>
</html>

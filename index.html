<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®¶åº­è¢å¹•æ™‚é–“ç®¡ç†</title>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: 'Poppins', sans-serif;
      margin: 20px;
      text-align: center;
    }
    #children {
      margin-top: 20px;
    }
    .child-card {
      background: #1c1c3c;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,212,255,0.4);
    }
    .points-box {
      background: #222;
      padding: 20px;
      border-radius: 15px;
      font-size: 30px;
      font-weight: bold;
      margin: 10px 0;
      color: #00d4ff;
    }
    .conversion-info {
      margin-top: 8px;
      font-size: 14px;
      color: #ccc;
    }
    .progress-bar-container {
      background: #222;
      border: 2px solid #00d4ff;
      border-radius: 30px;
      overflow: hidden;
      height: 50px;
      width: 80%;
      margin: 20px auto;
      position: relative;
    }
    .progress-bar-fill {
      height: 100%;
      width: 0%;
      transition: width 0.5s;
    }
    .progress-bar-text {
      position: absolute;
      width: 100%;
      text-align: center;
      top: 0;
      line-height: 50px;
      font-weight: bold;
      color: #fff;
      font-size: 20px;
    }
    .controls {
      margin-top: 10px;
    }
    .control-group {
      background: #2a2a5a;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    .control-group-title {
      margin-bottom: 10px;
      font-size: 18px;
      font-weight: bold;
      color: #00d4ff;
    }
    .control-group input, .control-group button, #reset-family {
      margin: 5px;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
    }
    .control-group button, #reset-family {
      background: #00d4ff;
      color: #111;
      cursor: pointer;
    }
    #family-select button {
      font-size: 20px;
      padding: 15px 30px;
      margin: 10px;
      border-radius: 10px;
      background: #00d4ff;
      color: #111;
      border: none;
      cursor: pointer;
    }
    .alert {
      color: #00ff88; /* æˆåŠŸæˆ–æç¤ºè¨Šæ¯é¡è‰² */
      font-weight: bold;
      margin-top: 10px;
      transition: opacity 0.5s ease;
      min-height: 1em; /* ç¢ºä¿å³ä½¿æ²’æœ‰å…§å®¹ä¹Ÿæœ‰é«˜åº¦ï¼Œé¿å…ä½ˆå±€è·³å‹• */
    }
     .alert.error {
        color: #ff6b6b; /* éŒ¯èª¤è¨Šæ¯é¡è‰² */
     }
  </style>
</head>
<body>

<h1>å®¶åº­è¢å¹•æ™‚é–“ç®¡ç†</h1>
<div id="family-select"></div>
<div id="current-family"></div>
<div id="children"></div>
<div style="margin-top: 30px;"><button id="reset-family" onclick="resetFamilyChoice()" style="display: none;">é‡æ–°é¸æ“‡å®¶åº­</button></div> <script>
// è«‹å°‡é€™è£¡çš„ URL æ›¿æ›ç‚ºæ‚¨é‡æ–°ç™¼å¸ƒ Apps Script ç¶²é æ‡‰ç”¨ç¨‹å¼å¾Œç²å–çš„ URL
const API_URL = "https://script.google.com/macros/s/AKfycbw29KdvF1gSJnTjcDn0LZCvJ06JLdK4YLE5L7V3Zy0ai6qHOONYmeV-AsMLA97N9mC-lA/exec";
let kids = []; // å„²å­˜å¾ Apps Script è¼‰å…¥çš„çµ±è¨ˆè³‡æ–™ (K:M å°æ‡‰åˆ° Name, Points, ScreenMinutes)
let family = localStorage.getItem('family') || ''; // å¾ localStorage ç²å–å„²å­˜çš„å®¶åº­é¸é …

// é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–é‚è¼¯ï¼š
// å¦‚æœ localStorage ä¸­å·²ç¶“æœ‰å„²å­˜çš„å®¶åº­é¸é …ï¼Œå‰‡ç›´æ¥è¼‰å…¥è³‡æ–™ï¼›
// å¦å‰‡ï¼Œé¡¯ç¤ºå®¶åº­é¸æ“‡æŒ‰éˆ•ã€‚
if (family) {
  console.log("é é¢è¼‰å…¥æ™‚ï¼Œå·²æ‰¾åˆ°å„²å­˜çš„å®¶åº­é¸é …:", family, "ï¼Œå˜—è©¦è¼‰å…¥è³‡æ–™...");
  // è¼‰å…¥è³‡æ–™ï¼Œç„¶å¾Œéš±è—é¸æ“‡æŒ‰éˆ•ä¸¦é¡¯ç¤ºé‡é¸æŒ‰éˆ•
  loadData().then(() => {
      document.getElementById('family-select').style.display = 'none'; // éš±è—é¸æ“‡æŒ‰éˆ•
      document.getElementById('reset-family').style.display = 'block'; // é¡¯ç¤ºé‡é¸æŒ‰éˆ•
  });
} else {
  console.log("é é¢è¼‰å…¥æ™‚ï¼Œæœªæ‰¾åˆ°å„²å­˜çš„å®¶åº­é¸é …ï¼Œé¡¯ç¤ºå®¶åº­é¸æ“‡...");
  chooseFamily(); // å‘¼å« chooseFamily å‡½æ•¸é¡¯ç¤ºé¸æ“‡æŒ‰éˆ•
  document.getElementById('reset-family').style.display = 'none'; // éš±è—é‡é¸æŒ‰éˆ•
}


// é¡¯ç¤ºå®¶åº­é¸æ“‡æŒ‰éˆ•çš„å‡½æ•¸
function chooseFamily() {
  const container = document.getElementById('family-select');
   container.style.display = 'block'; // ç¢ºä¿å®¶åº­é¸æ“‡å€åŸŸé¡¯ç¤º
  container.innerHTML = `
    <p>è«‹é¸æ“‡å®¶åº­:</p>
    <button onclick="selectFamily('ev-family')">Emmett & Miles</button>
    <button onclick="selectFamily('ap-family')">Archer & Tessa</button>
  `;
  document.getElementById('current-family').innerText = ''; // æ¸…ç©ºé¡¯ç¤ºç•¶å‰å®¶åº­çš„å€åŸŸ
  document.getElementById('children').innerHTML = ''; // æ¸…ç©ºé¡¯ç¤ºå­©å­è³‡æ–™çš„å€åŸŸ
}


// é¸æ“‡å®¶åº­å¾Œè§¸ç™¼çš„å‡½æ•¸
function selectFamily(fam) {
  family = fam; // è¨­å®šå…¨å±€è®Šæ•¸ family
  localStorage.setItem('family', family); // å°‡é¸æ“‡çš„å®¶åº­å„²å­˜åˆ° localStorage
  console.log("å·²é¸æ“‡å®¶åº­:", family);
  document.getElementById('family-select').style.display = 'none'; // éš±è—å®¶åº­é¸æ“‡æŒ‰éˆ•å€åŸŸ
  document.getElementById('reset-family').style.display = 'block'; // é¡¯ç¤ºã€Œé‡æ–°é¸æ“‡å®¶åº­ã€æŒ‰éˆ•
  loadData(); // å‘¼å« loadData å‡½æ•¸è¼‰å…¥é¸å®šå®¶åº­çš„è³‡æ–™
}


// é‡æ–°é¸æ“‡å®¶åº­çš„å‡½æ•¸
function resetFamilyChoice() {
  console.log("é‡æ–°é¸æ“‡å®¶åº­...");
  localStorage.removeItem('family'); // å¾ localStorage ç§»é™¤å„²å­˜çš„å®¶åº­é¸é …
  family = ''; // æ¸…ç©ºå…¨å±€è®Šæ•¸ family
  document.getElementById('children').innerHTML = ''; // æ¸…ç©ºé¡¯ç¤ºçš„å­©å­è³‡æ–™
  document.getElementById('current-family').innerText = ''; // æ¸…ç©ºé¡¯ç¤ºçš„ç•¶å‰å®¶åº­
  document.getElementById('reset-family').style.display = 'none'; // éš±è—ã€Œé‡æ–°é¸æ“‡å®¶åº­ã€æŒ‰éˆ•
  chooseFamily(); // é‡æ–°é¡¯ç¤ºå®¶åº­é¸æ“‡æŒ‰éˆ•
}


// å¾ Google Sheet çš„ K:M æ¬„ä½è¼‰å…¥çµ±è¨ˆè³‡æ–™çš„å‡½æ•¸
async function loadData() {
  // åœ¨é€™è£¡é‡æ–°æª¢æŸ¥ä¸€æ¬¡ familyï¼Œç¢ºä¿åœ¨å‘¼å« fetch ä¹‹å‰ family æ˜¯æœ‰å€¼çš„
  if (!family) {
      console.error("loadData å‡½æ•¸è¢«å‘¼å«ï¼Œä½† family è®Šæ•¸ç‚ºç©ºã€‚é€™ä¸æ‡‰è©²ç™¼ç”Ÿã€‚");
      chooseFamily(); // ä½œç‚ºä¸€å€‹å‚™ç”¨æ–¹æ¡ˆï¼Œå¦‚æœç™¼ç”Ÿæ­¤æƒ…æ³å‰‡é¡¯ç¤ºé¸æ“‡æŒ‰éˆ•
      return;
  }

  console.log("æ­£åœ¨å¾ Apps Script è¼‰å…¥ K:M çµ±è¨ˆè³‡æ–™ï¼Œfamily:", family);
  document.getElementById('children').innerHTML = '<div>æ­£åœ¨è¼‰å…¥è³‡æ–™...</div>'; // é¡¯ç¤ºè¼‰å…¥ä¸­çš„æ–‡å­—
  // é¡¯ç¤ºç•¶å‰é¸æ“‡çš„å®¶åº­åç¨±
  document.getElementById('current-family').innerText = `ç›®å‰å®¶åº­ï¼š${family === 'ev-family' ? 'Emmett & Miles' : 'Archer & Tessa'}`;

  try {
      // ä½¿ç”¨ fetch API ç™¼é€ GET è«‹æ±‚åˆ° Apps Script
      const res = await fetch(`${API_URL}?family=${family}`);
      console.log("æ”¶åˆ°è³‡æ–™è¼‰å…¥è«‹æ±‚çš„å›æ‡‰:", res); // è¨˜éŒ„æ”¶åˆ°çš„å›æ‡‰å°è±¡

      if (!res.ok) {
        // å¦‚æœ HTTP ç‹€æ…‹ç¢¼ä¸æ˜¯æˆåŠŸçš„
        const text = await res.text();
        const errorMsg = `HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${res.status}, è¨Šæ¯: ${text}`;
        console.error("è³‡æ–™è¼‰å…¥å¤±æ•—ï¼ŒHTTP éŒ¯èª¤:", errorMsg); // è¨˜éŒ„éŒ¯èª¤è¨Šæ¯
        document.getElementById('children').innerHTML = `<div class="alert error">è³‡æ–™è¼‰å…¥éŒ¯èª¤: ${errorMsg}</div>`; // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        kids = []; // æ¸…ç©º kids è³‡æ–™
        return;
      }

      // å˜—è©¦è®€å–å›æ‡‰çš„ JSON å…§å®¹
      const data = await res.json();
      console.log("è³‡æ–™è¼‰å…¥æˆåŠŸï¼Œè§£æå¾Œçš„è³‡æ–™:", data); // è¨˜éŒ„è§£æå¾Œçš„è³‡æ–™

      // æª¢æŸ¥å¾ Apps Script è¿”å›çš„è³‡æ–™ä¸­æ˜¯å¦åŒ…å«éŒ¯èª¤è¨Šæ¯å±¬æ€§ (å¦‚æœ Apps Script è¿”å›äº†éŒ¯èª¤å°è±¡)
      if (data && data.error) {
          document.getElementById('children').innerHTML = `<div class="alert error">éŒ¯èª¤: ${data.error}</div>`; // é¡¯ç¤ºä¾†è‡ªå¾Œç«¯çš„éŒ¯èª¤è¨Šæ¯
          kids = []; // æ¸…ç©º kids è³‡æ–™
          console.error("Apps Script è¿”å›éŒ¯èª¤è³‡æ–™:", data.error);
          return;
      }

      // æª¢æŸ¥è¿”å›çš„è³‡æ–™æ˜¯å¦ç‚ºé™£åˆ—ä¸”ä¸ç‚ºç©º
      if (!Array.isArray(data) || data.length === 0) {
        document.getElementById('children').innerHTML = '<div class="alert">æ²’æœ‰æ‰¾åˆ°è³‡æ–™</div>'; // é¡¯ç¤ºæœªæ‰¾åˆ°è³‡æ–™è¨Šæ¯
        kids = []; // æ¸…ç©º kids è³‡æ–™
         console.log("å¾ Apps Script ç²å–çš„è³‡æ–™ç‚ºç©ºæˆ–ä¸æ˜¯é™£åˆ—ã€‚");
        return;
      }

      // å¦‚æœè³‡æ–™è¼‰å…¥æˆåŠŸä¸”æœ‰æ•ˆ
      // å°‡ç²å–çš„è³‡æ–™å„²å­˜åˆ° kids è®Šæ•¸
      // æ•¸æ“šæ ¼å¼æ‡‰è©²æ˜¯ [{ Name: '...', Points: '...', ScreenMinutes: '...' }, ...]
      kids = data;
      render(); // å‘¼å« render å‡½æ•¸ä¾†é¡¯ç¤ºè³‡æ–™

  } catch (error) {
      // æ•ç² fetch è«‹æ±‚éç¨‹ä¸­ç™¼ç”Ÿçš„ä»»ä½•éŒ¯èª¤ (åŒ…æ‹¬ç¶²è·¯éŒ¯èª¤æˆ–ä¹‹å‰æ‹‹å‡ºçš„ HTTP éŒ¯èª¤)
      console.error("è³‡æ–™è¼‰å…¥ç™¼ç”ŸéŒ¯èª¤:", error); // è¨˜éŒ„éŒ¯èª¤è¨Šæ¯
       // åœ¨ç¶²é ä¸Šé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
      document.getElementById('children').innerHTML = `<div class="alert error">è³‡æ–™è¼‰å…¥éŒ¯èª¤: ${error.message}</div>`;
      kids = []; // æ¸…ç©º kids è³‡æ–™
  }
}


// å°‡ kids é™£åˆ—ä¸­çš„çµ±è¨ˆæ•¸æ“šæ¸²æŸ“åˆ°ç¶²é ä¸Šçš„å‡½æ•¸
function render() {
  const container = document.getElementById('children');
  container.innerHTML = ''; // æ¸…ç©ºç¾æœ‰çš„å­©å­åˆ—è¡¨é¡¯ç¤º

  if (!Array.isArray(kids) || kids.length === 0) {
      console.log("æ¸²æŸ“å‡½æ•¸è¢«å‘¼å«ï¼Œä½† kids é™£åˆ—ç‚ºç©ºã€‚");
      document.getElementById('children').innerHTML = '<div class="alert">æ²’æœ‰æ‰¾åˆ°è³‡æ–™å¯ä¾›é¡¯ç¤º</div>';
      return;
  }

  // éš±è—å®¶åº­é¸æ“‡æŒ‰éˆ•ï¼Œç¢ºä¿åªé¡¯ç¤ºå­©å­è³‡æ–™å’Œé‡é¸æŒ‰éˆ•
   document.getElementById('family-select').style.display = 'none';


  kids.forEach((kid, index) => {
    // ç‚ºæ¯å€‹å­©å­å‰µå»ºä¸€å€‹é¡¯ç¤ºå¡ç‰‡
    const maxMinutes = 90; // å‡è¨­æœ€å¤§è¢å¹•æ™‚é–“ç‚º 90 åˆ†é˜
    // ç¢ºä¿å¾ Apps Script ç²å–çš„ Points å’Œ ScreenMinutes æ˜¯æ•¸å­—
    const currentPoints = parseFloat(kid.Points) || 0;
    const currentScreenMinutes = parseFloat(kid.ScreenMinutes) || 0;


    // è¨ˆç®—è¢å¹•æ™‚é–“çš„ç™¾åˆ†æ¯”é€²åº¦æ¢
    const percentage = Math.min(100, (currentScreenMinutes / maxMinutes) * 100);
    // è¨ˆç®—é»æ•¸å°æ‡‰çš„åˆ†é˜å’Œé‡‘é¡ (é€™è£¡å‡è¨­æ˜¯çµ±è¨ˆå¾Œçš„ç¸½é»æ•¸å’Œç¸½è¢å¹•æ™‚é–“)
    const minutes = currentPoints * 2; // é€™å€‹è½‰æ›é‚è¼¯ä¼¼ä¹ç”¨æ–¼é»æ•¸å¯ä»¥å…Œæ›åˆ†é˜
    const cash = currentPoints * 5; // é€™å€‹è½‰æ›é‚è¼¯ä¼¼ä¹ç”¨æ–¼é»æ•¸å¯ä»¥å…Œæ›é‡‘é¡
    // æ ¹æ“šè¢å¹•æ™‚é–“æ±ºå®šé€²åº¦æ¢é¡è‰²
    const barColor = currentScreenMinutes <= 10 ? 'linear-gradient(90deg, #ff4d4d, #ff0000)' : 'linear-gradient(90deg, #00d4ff, #005eff)';

    const card = document.createElement('div');
    card.className = 'child-card';
    card.innerHTML = `
      <h2>${kid.Name || 'ç„¡å§“å'}</h2>
      <div id="alert${index}" class="alert" style="opacity:0;"></div> <div class="points-box">
        ç¸½é»æ•¸: ${currentPoints} é»
        <div class="conversion-info">åŸºæ–¼ç¸½é»æ•¸: â±ï¸ ${minutes} åˆ†é˜ ğŸ’° ${cash} å…ƒ</div>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar-fill" style="width:${percentage}%; background: ${barColor};"></div>
        <div class="progress-bar-text">${currentScreenMinutes}åˆ†</div>
      </div>
      <div class="controls">
        <div class="control-group">
          <div class="control-group-title">â³ è¢å¹•æ™‚é–“è®Šå‹•è¨˜éŒ„</div>
          <input type="number" id="screenChange${index}" placeholder="è¼¸å…¥è®Šå‹•å€¼ (åˆ†é˜)">
           <input type="text" id="screenReason${index}" placeholder="åŸå› ">
          <button onclick="recordScreenChange(${index})">è¨˜éŒ„è®Šå‹•</button>
        </div>
        <div class="control-group">
          <div class="control-group-title">ğŸ¯ é»æ•¸è®Šå‹•è¨˜éŒ„</div>
          <input type="number" id="pointsChange${index}" placeholder="è¼¸å…¥è®Šå‹•å€¼">
          <input type="text" id="pointsReason${index}" placeholder="åŸå› ">
          <button onclick="recordPointsChange(${index})">è¨˜éŒ„è®Šå‹•</button>
        </div>
         </div>
       `;
    container.appendChild(card);
     // åœ¨æ¸²æŸ“å¾Œï¼Œéš±è— alert è¨Šæ¯
     hideAlert(index);
  });
}

// é¡¯ç¤ºæ“ä½œçµæœè¨Šæ¯çš„å‡½æ•¸
function showAlert(index, message, isError = false) {
    const alertElement = document.getElementById(`alert${index}`);
    if (alertElement) {
        alertElement.innerText = message;
        alertElement.className = isError ? 'alert error' : 'alert'; // æ ¹æ“šæ˜¯å¦ç‚ºéŒ¯èª¤æ·»åŠ  class
        alertElement.style.opacity = 1; // é¡¯ç¤ºè¨Šæ¯
        // å¯é¸ï¼šè¨­å®šè¨ˆæ™‚å™¨åœ¨å¹¾ç§’å¾Œè‡ªå‹•éš±è—
        // setTimeout(() => {
        //     hideAlert(index);
        // }, 5000); // 5ç§’å¾Œéš±è—
    }
}

// éš±è—æ“ä½œçµæœè¨Šæ¯çš„å‡½æ•¸
function hideAlert(index) {
     const alertElement = document.getElementById(`alert${index}`);
      if (alertElement) {
        alertElement.innerText = '';
         alertElement.className = 'alert'; // ç§»é™¤ error class
        alertElement.style.opacity = 0; // éš±è—è¨Šæ¯
      }
}


// è¨˜éŒ„é»æ•¸è®Šå‹•åˆ° A:F çš„å‡½æ•¸
function recordPointsChange(index) {
  const pointsChangeInput = document.getElementById(`pointsChange${index}`);
  const pointsChange = parseFloat(pointsChangeInput.value); // å…è¨±å°æ•¸é»è®Šå‹•
  const reasonInput = document.getElementById(`pointsReason${index}`);
  const reason = reasonInput.value.trim(); // ç²å–åŸå› ä¸¦å»é™¤å‰å¾Œç©ºç™½

  if (isNaN(pointsChange) || reason === '') {
      console.warn("è¨˜éŒ„é»æ•¸è®Šå‹•ï¼šè¼¸å…¥ç„¡æ•ˆã€‚è®Šå‹•å€¼æˆ–åŸå› ç‚ºç©ºã€‚", pointsChangeInput.value, reason);
      showAlert(index, 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é»æ•¸è®Šå‹•å€¼å’ŒåŸå› ', true); // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
      return;
  }

  if (!family || !kids[index] || !kids[index].Name) {
       console.error("è¨˜éŒ„é»æ•¸è®Šå‹•ï¼šç¼ºå°‘ family æˆ–å­©å­è³‡æ–™ã€‚");
       showAlert(index, 'å„²å­˜éŒ¯èª¤: ç¼ºå°‘å®¶åº­æˆ–å­©å­è³‡æ–™', true); // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
       return;
  }

  // æº–å‚™è¦é™„åŠ åˆ° A:F çš„æ•¸æ“šå°è±¡
  const dataToAppend = {
      Name: kids[index].Name, // Bæ¬„: Name
      PointsChange: pointsChange, // Cæ¬„: PointsChange
      ScreenMinutesChange: '', // Dæ¬„: ScreenMinutesChange (é»æ•¸è®Šå‹•æ™‚è¢å¹•æ™‚é–“è®Šå‹•ç‚ºç©º)
      Reason: reason, // Eæ¬„: Reason
      // Family å’Œ Timestamp æœƒåœ¨ Apps Script ä¸­è™•ç†
  };

   console.log("æº–å‚™è¨˜éŒ„é»æ•¸è®Šå‹•æ•¸æ“š:", dataToAppend);
   showAlert(index, 'æ­£åœ¨è¨˜éŒ„é»æ•¸è®Šå‹•...');

  // ç™¼é€ POST è«‹æ±‚å„²å­˜æ•¸æ“š (é€™æ¬¡æ˜¯é™„åŠ åˆ° A:F)
  sendRecord(dataToAppend, index);

  // æ¸…ç©ºè¼¸å…¥æ¡†
  pointsChangeInput.value = '';
  reasonInput.value = '';
}


// è¨˜éŒ„è¢å¹•æ™‚é–“è®Šå‹•åˆ° A:F çš„å‡½æ•¸
function recordScreenChange(index) {
  const screenChangeInput = document.getElementById(`screenChange${index}`);
  const screenChange = parseFloat(screenChangeInput.value); // å…è¨±å°æ•¸é»è®Šå‹•
   const reasonInput = document.getElementById(`screenReason${index}`);
  const reason = reasonInput.value.trim();

  if (isNaN(screenChange) || reason === '') {
      console.warn("è¨˜éŒ„è¢å¹•æ™‚é–“è®Šå‹•ï¼šè¼¸å…¥ç„¡æ•ˆã€‚è®Šå‹•å€¼æˆ–åŸå› ç‚ºç©ºã€‚", screenChangeInput.value, reason);
       showAlert(index, 'è«‹è¼¸å…¥æœ‰æ•ˆçš„è¢å¹•æ™‚é–“è®Šå‹•å€¼å’ŒåŸå› ', true); // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
      return;
  }

   if (!family || !kids[index] || !kids[index].Name) {
       console.error("è¨˜éŒ„è¢å¹•æ™‚é–“è®Šå‹•ï¼šç¼ºå°‘ family æˆ–å­©å­è³‡æ–™ã€‚");
        showAlert(index, 'å„²å­˜éŒ¯èª¤: ç¼ºå°‘å®¶åº­æˆ–å­©å­è³‡æ–™', true); // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
       return;
  }

  // æº–å‚™è¦é™„åŠ åˆ° A:F çš„æ•¸æ“šå°è±¡
  const dataToAppend = {
      Name: kids[index].Name, // Bæ¬„: Name
      PointsChange: '', // Cæ¬„: PointsChange (è¢å¹•æ™‚é–“è®Šå‹•æ™‚é»æ•¸è®Šå‹•ç‚ºç©º)
      ScreenMinutesChange: screenChange, // Dæ¬„: ScreenMinutesChange
      Reason: reason, // Eæ¬„: Reason
      // Family å’Œ Timestamp æœƒåœ¨ Apps Script ä¸­è™•ç†
  };

   console.log("æº–å‚™è¨˜éŒ„è¢å¹•æ™‚é–“è®Šå‹•æ•¸æ“š:", dataToAppend);
    showAlert(index, 'æ­£åœ¨è¨˜éŒ„è¢å¹•æ™‚é–“è®Šå‹•...');

  // ç™¼é€ POST è«‹æ±‚å„²å­˜æ•¸æ“š (é™„åŠ åˆ° A:F)
  sendRecord(dataToAppend, index);

  // æ¸…ç©ºè¼¸å…¥æ¡†
  screenChangeInput.value = '';
  reasonInput.value = '';
}


// ç™¼é€ POST è«‹æ±‚å°‡è®Šå‹•è¨˜éŒ„å„²å­˜åˆ° A:F çš„å‡½æ•¸
// é€™è£¡æ¥æ”¶ä¸€å€‹åŒ…å«è¦é™„åŠ æ•¸æ“šçš„å°è±¡ dataToAppendï¼Œä»¥åŠç”¨æ–¼é¡¯ç¤ºè¨Šæ¯çš„å­©å­ç´¢å¼• index
async function sendRecord(dataToAppend, index) {
   if (!family) {
      console.error("sendRecord å‡½æ•¸è¢«å‘¼å«ï¼Œä½† family è®Šæ•¸ç‚ºç©ºã€‚ç„¡æ³•å„²å­˜ã€‚");
       showAlert(index, 'å„²å­˜éŒ¯èª¤: æœªé¸æ“‡å®¶åº­', true);
      return;
  }
   console.log("å˜—è©¦å°‡è¨˜éŒ„æ•¸æ“šç™¼é€åˆ° Apps Scriptï¼Œfamily:", family, "æ•¸æ“š:", JSON.stringify(dataToAppend));

  try {
      const res = await fetch(`${API_URL}?family=${family}`, {
        method: 'POST', // è¨­å®šè«‹æ±‚æ–¹æ³•ç‚º POST
        body: JSON.stringify(dataToAppend), // å°‡è¦é™„åŠ çš„æ•¸æ“šå°è±¡è½‰æ›ç‚º JSON å­—ä¸²ä½œç‚ºè«‹æ±‚ä¸»é«”
        headers: {
          'Content-Type': 'application/json' // è¨­å®šè«‹æ±‚é ­ï¼Œå‘ŠçŸ¥ä¼ºæœå™¨ç™¼é€çš„æ˜¯ JSON æ•¸æ“š
        }
      });
      console.log("æ”¶åˆ°å„²å­˜è¨˜éŒ„è«‹æ±‚çš„å›æ‡‰:", res);

      if (!res.ok) {
          const text = await res.text();
          const errorMsg = `HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${res.status}, è¨Šæ¯: ${text}`;
          console.error("è¨˜éŒ„å„²å­˜å¤±æ•—ï¼ŒHTTP éŒ¯èª¤:", errorMsg);
          showAlert(index, `å„²å­˜éŒ¯èª¤: ${errorMsg}`, true); // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
          return;
      }

      const responseText = await res.text();
      console.log("è¨˜éŒ„å„²å­˜æˆåŠŸï¼ŒApps Script å›æ‡‰æ–‡å­—:", responseText);

      // æ ¹æ“š Apps Script è¿”å›çš„æ–‡å­—åˆ¤æ–·æ˜¯å¦å„²å­˜æˆåŠŸ
      if (responseText === 'Done') {
          console.log("Apps Script æˆåŠŸè™•ç†è¨˜éŒ„å„²å­˜è«‹æ±‚ã€‚");
          showAlert(index, 'è¨˜éŒ„æˆåŠŸï¼');
          // å¯é¸ï¼šè¨˜éŒ„æˆåŠŸå¾Œé‡æ–°è¼‰å…¥æ•¸æ“šï¼Œä»¥åæ˜ ç¸½è¨ˆçš„è®ŠåŒ– (å¦‚æœæ‚¨çš„ç¸½è¨ˆæ¬„ä½æ˜¯è‡ªå‹•è¨ˆç®—çš„)
           loadData();
      } else if (responseText.startsWith('Error:')) {
           console.error("Apps Script å ±å‘ŠéŒ¯èª¤ï¼š", responseText);
           showAlert(index, `å„²å­˜éŒ¯èª¤: ${responseText.substring(7)}`, true); // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ (ç§»é™¤ "Error: ")
       }
       else {
           console.warn("Apps Script è¿”å›éé æœŸè¨Šæ¯:", responseText);
            showAlert(index, `å„²å­˜éŒ¯èª¤: éé æœŸå›æ‡‰ (${responseText})`, true); // é¡¯ç¤ºéé æœŸè¨Šæ¯
       }

  } catch (error) {
      console.error("ç™¼é€å„²å­˜è¨˜éŒ„è«‹æ±‚ç™¼ç”ŸéŒ¯èª¤:", error);
       showAlert(index, `å„²å­˜è¨˜éŒ„è«‹æ±‚éŒ¯èª¤: ${error.message}`, true); // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
  }
}


// åˆå§‹åŒ–æ™‚å‘¼å« loadDataï¼Œé€™å€‹å·²ç¶“åœ¨æœ€ä¸Šé¢è™•ç†äº†


</script>

<div style="margin-top: 60px; font-size: 0.9em; color: #aaa; text-align: center;">
    Made by Evelyn YT ï½œÂ© 2025 | 2025/4/28 10:05
</div>
</body>
</html>
